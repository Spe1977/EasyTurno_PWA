<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyTurno</title>
    
    <meta name="theme-color" content="#4a90e2"/>
    <link rel="manifest" href="manifest.json">
    <!-- Questo link è per iOS, per garantire che l'icona appaia correttamente -->
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .modal-enter-active { animation: fadeIn 0.2s ease-out; }
        .modal-exit-active { animation: fadeOut 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, createContext, useContext, useRef } = React;

        // --- DATABASE & CONFIG ---
        const db = new Dexie('EasyTurnoDB');
        db.version(3).stores({
            turni: '++id, titolo, inizio, fine, colore, serieId, note',
            serie: '++id'
        }).upgrade(tx => {});
        db.open().catch(err => console.error("Failed to open db: " + err.stack));
        const COLORS = ['#4A90E2', '#50E3C2', '#F5A623', '#F8E71C', '#BD10E0', '#9013FE', '#D0021B', '#7ED321'];

        // --- I18N PROVIDER ---
        const translations = { it: { appName: "EasyTurno", addShift: "Aggiungi Turno", editShift: "Modifica Turno", shiftTitle: "Titolo Turno", placeholderTitle: "Es. Turno Mattina", startDate: "Data Inizio", startTime: "Ora Inizio", endDate: "Data Fine", endTime: "Ora Fine", color: "Colore", save: "Salva", cancel: "Annulla", delete: "Elimina", confirmDeleteTitle: "Conferma Eliminazione", confirmDeleteMessage: "Sei sicuro di voler eliminare questo turno?", noShifts: "Nessun turno programmato.", addFirstShift: "Inizia aggiungendo il tuo primo turno!", language: "Lingua", view: "Vista", list: "Lista", week: "Settimana", month: "Mese", recurringShift: "Turno Riccorrente", frequency: "Frequenza", repeatsEvery: "Si ripete ogni", daily: "Giornaliera", weekly: "Settimanale", monthly: "Mensile", yearly: "Annuale", days: "giorni", weeks: "settimane", months: "mesi", years: "anni", editRecurringTitle: "Modifica evento ricorrente", editRecurringMessage: "Cosa vuoi modificare?", thisEventOnly: "Solo questo evento", thisAndFutureEvents: "Questo e gli eventi futuri", allEventsInSeries: "Tutti gli eventi della serie", deleteRecurringTitle: "Elimina evento ricorrente", deleteRecurringMessage: "Cosa vuoi eliminare?", loading: "Caricamento...", colorLabel: "Seleziona colore", today: "Oggi", next: "Succ.", prev: "Prec.", settings: "Impostazioni", dataManagement: "Gestione Dati", backup: "Backup", backupDesc: "Salva tutti i tuoi dati in un file.", restore: "Ripristino", restoreDesc: "Carica i dati da un file di backup.", reset: "Reset", resetDesc: "Cancella tutti i dati dall'applicazione.", confirmResetTitle: "Conferma Reset", confirmResetMessage: "ATTENZIONE: Questa azione è irreversibile. Sei sicuro di voler cancellare tutti i dati?", dataRestored: "Dati ripristinati con successo.", backupError: "Errore durante il backup.", restoreError: "Errore durante il ripristino: il file potrebbe essere corrotto.", notes: "Note / Compiti" }, en: { appName: "EasyTurno", addShift: "Add Shift", editShift: "Edit Shift", shiftTitle: "Shift Title", placeholderTitle: "E.g. Morning Shift", startDate: "Start Date", startTime: "Start Time", endDate: "End Date", endTime: "End Time", color: "Color", save: "Save", cancel: "Cancel", delete: "Delete", confirmDeleteTitle: "Confirm Deletion", confirmDeleteMessage: "Are you sure you want to delete this shift?", noShifts: "No scheduled shifts.", addFirstShift: "Start by adding your first shift!", language: "Language", view: "View", list: "List", week: "Week", month: "Month", recurringShift: "Recurring Shift", frequency: "Frequency", repeatsEvery: "Repeats every", daily: "Daily", weekly: "Weekly", monthly: "Monthly", yearly: "Yearly", days: "days", weeks: "weeks", months: "months", years: "years", editRecurringTitle: "Edit recurring event", editRecurringMessage: "What do you want to edit?", thisEventOnly: "Only this event", thisAndFutureEvents: "This and future events", allEventsInSeries: "All events in the series", deleteRecurringTitle: "Delete recurring event", deleteRecurringMessage: "What do you want to delete?", loading: "Loading...", colorLabel: "Select color", today: "Today", next: "Next", prev: "Prev", settings: "Settings", dataManagement: "Data Management", backup: "Backup", backupDesc: "Save all your data to a file.", restore: "Restore", restoreDesc: "Load data from a backup file.", reset: "Reset", resetDesc: "Delete all data from the application.", confirmResetTitle: "Confirm Reset", confirmResetMessage: "WARNING: This action is irreversible. Are you sure you want to delete all data?", dataRestored: "Data restored successfully.", backupError: "Error during backup.", restoreError: "Error during restore: the file might be corrupt.", notes: "Notes / Tasks" } };
        const LanguageContext = createContext();
        function LanguageProvider({ children }) { const [language, setLanguage] = useState(localStorage.getItem('easyturno-lang') || 'it'); useEffect(() => { localStorage.setItem('easyturno-lang', language); document.documentElement.lang = language; }, [language]); const t = useCallback((key) => translations[language][key] || key, [language]); const formatDate = useCallback((dateString, options = {}) => { const date = new Date(dateString); const lang = language === 'it' ? 'it-IT' : 'en-CA'; const timeLang = language === 'it' ? 'it-IT' : 'en-US'; if(options.timeOnly) return date.toLocaleTimeString(timeLang, { hour: '2-digit', minute: '2-digit', hour12: false }); if(options.dateOnly) return date.toLocaleDateString(lang, { day: '2-digit', month: '2-digit', year: 'numeric' }); return date.toLocaleDateString(lang, { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + date.toLocaleTimeString(timeLang, { hour: '2-digit', minute: '2-digit', hour12: false }); }, [language]); const value = { language, setLanguage, t, formatDate }; return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>; }
        const useI18n = () => useContext(LanguageContext);
        
        // --- DATA LOGIC HOOK (useTurni) ---
        function useTurni() { const [turni, setTurni] = useState([]); const [isLoading, setIsLoading] = useState(true); const fetchTurni = useCallback(async () => { setIsLoading(true); try { const allTurni = await db.turni.orderBy('inizio').toArray(); setTurni(allTurni); } catch (e) { console.error(e); } finally { setIsLoading(false); } }, []); useEffect(() => { fetchTurni(); }, [fetchTurni]); const addTurno = useCallback(async (d) => { try { if (d.recurrence) { const sId = await db.serie.add(d.recurrence); await db.turni.bulkAdd(generateRecurringEvents(d, d.recurrence, sId)); } else { await db.turni.add(d); } await fetchTurni(); } catch (e) { console.error(e); } }, [fetchTurni]); const updateTurno = useCallback(async (t, c) => { try { if (!t.serieId || c === 'single') { await db.turni.update(t.id, { ...t, serieId: t.serieId ? null : undefined }); } else { const rule = await db.serie.get(t.serieId); if (rule) { if (c === 'future') { await db.turni.where({ serieId: t.serieId }).and(i => new Date(i.inizio) >= new Date(t.inizio)).delete(); await db.turni.bulkAdd(generateRecurringEvents(t, rule, t.serieId)); } else if (c === 'all') { const firstEvents = await db.turni.where({ serieId: t.serieId }).sortBy('inizio'); if (firstEvents.length > 0) { const firstEvent = firstEvents[0]; const firstEventStartDate = new Date(firstEvent.inizio); const editedStartTime = new Date(t.inizio); const editedEndTime = new Date(t.fine); const duration = editedEndTime.getTime() - editedStartTime.getTime(); const newBaseStartDate = new Date(firstEventStartDate); newBaseStartDate.setHours(editedStartTime.getHours(), editedStartTime.getMinutes(), editedStartTime.getSeconds()); const newBaseEndDate = new Date(newBaseStartDate.getTime() + duration); const base = { ...t, inizio: newBaseStartDate.toISOString(), fine: newBaseEndDate.toISOString() }; await db.turni.where({ serieId: t.serieId }).delete(); await db.turni.bulkAdd(generateRecurringEvents(base, rule, t.serieId)); } } } } await fetchTurni(); } catch (e) { console.error(e); } }, [fetchTurni]); const deleteTurno = useCallback(async (t, c) => { try { if (!t.serieId || c === 'single') { await db.turni.delete(t.id); } else { if (c === 'future') { await db.turni.where({ serieId: t.serieId }).and(i => new Date(i.inizio) >= new Date(t.inizio)).delete(); } else if (c === 'all') { await db.turni.where({ serieId: t.serieId }).delete(); await db.serie.delete(t.serieId); } } await fetchTurni(); } catch (e) { console.error(e); } }, [fetchTurni]); const resetData = useCallback(async () => { try { await db.turni.clear(); await db.serie.clear(); await fetchTurni(); } catch(e) { console.error(e); } }, [fetchTurni]); const restoreData = useCallback(async (data) => { try { await db.transaction('rw', db.turni, db.serie, async () => { await db.turni.clear(); await db.serie.clear(); await db.turni.bulkAdd(data.turni); await db.serie.bulkAdd(data.serie); }); await fetchTurni(); } catch(e) { console.error(e); throw e; } }, [fetchTurni]); return { turni, isLoading, addTurno, updateTurno, deleteTurno, resetData, restoreData, fetchTurni }; }

        // --- UTILITY FUNCTIONS ---
        const generateRecurringEvents = (base, recur, sId) => { const evs = []; let { ruleType, interval } = recur; let start = new Date(base.inizio); let end = new Date(base.fine); const limit = new Date(); limit.setFullYear(limit.getFullYear() + 2); while (start < limit) { evs.push({ titolo: base.titolo, colore: base.colore, inizio: start.toISOString(), fine: end.toISOString(), serieId: sId, note: base.note || '' }); switch (ruleType) { case 'daily': start.setDate(start.getDate() + Number(interval)); end.setDate(end.getDate() + Number(interval)); break; case 'weekly': start.setDate(start.getDate() + Number(interval) * 7); end.setDate(end.getDate() + Number(interval) * 7); break; case 'monthly': start.setMonth(start.getMonth() + Number(interval)); end.setMonth(end.getMonth() + Number(interval)); break; case 'yearly': start.setFullYear(start.getFullYear() + Number(interval)); end.setFullYear(end.getFullYear() + Number(interval)); break; default: return evs; } } return evs; };
        const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        const toInputDateValue = (date) => date.toISOString().split('T')[0];
        const toInputTimeValue = (date) => date.toTimeString().slice(0, 5);
        
        // --- UI COMPONENTS ---
        function AppHeader({ view, setView, onSettingsClick }) { const { t, language, setLanguage } = useI18n(); return ( <header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40"> <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center"> <div className="flex items-center"> <svg className="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> <h1 className="ml-3 text-2xl font-bold text-blue-600 dark:text-blue-400">{t('appName')}</h1> </div> <div className="flex items-center space-x-2 sm:space-x-4"> <div className="flex items-center space-x-2"> {['list', 'week', 'month'].map(v => <button key={v} onClick={() => setView(v)} className={`px-3 py-2 text-sm font-semibold rounded-md transition-colors shadow-sm ${view === v ? 'bg-blue-600 text-white' : 'bg-blue-400 text-white hover:bg-blue-500'}`}>{t(v)}</button>)} </div> <select value={language} onChange={e => setLanguage(e.target.value)} className="form-select w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="it">🇮🇹 Italiano</option><option value="en">🇬🇧 English</option> </select> <button onClick={onSettingsClick} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" aria-label={t('settings')}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6 text-gray-600 dark:text-gray-300">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                            </svg></button> </div> </div> </header> ); }
        function TurnoList({ turni, onEdit, onDelete }) { const { t } = useI18n(); if (turni.length === 0) return (<div className="text-center py-16"><svg className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 className="mt-2 text-lg font-medium text-gray-900 dark:text-white">{t('noShifts')}</h3><p className="mt-1 text-sm text-gray-500 dark:text-gray-400">{t('addFirstShift')}</p></div>); return <div className="space-y-4">{turni.map(turno => <TurnoItem key={turno.id} turno={turno} onEdit={onEdit} onDelete={onDelete} />)}</div>; }
        function FloatingActionButton({ onClick }) { const { t } = useI18n(); return (<button onClick={onClick} aria-label={t('addShift')} className="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900 z-30"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>); }
        function TurnoModal({ turno, onClose, onSave }) { const { t } = useI18n(); const getInitialState = () => { const now = new Date(); const startDate = turno?.inizio ? new Date(turno.inizio) : now; const endDate = turno?.fine ? new Date(turno.fine) : now; return { titolo: turno?.titolo || '', colore: turno?.colore || COLORS[0], startDate: toInputDateValue(startDate), startTime: toInputTimeValue(startDate), endDate: toInputDateValue(endDate), endTime: toInputTimeValue(endDate), note: turno?.note || '', }; }; const [formData, setFormData] = useState(getInitialState); const [isRecurring, setIsRecurring] = useState(false); const [recurrence, setRecurrence] = useState({ ruleType: 'daily', interval: 1 }); const isEditMode = !!turno?.id; const FREQUENCY_OPTIONS = { daily: { intervals: [1, 3, 5, 8, 10, 15], unit: t('days') }, weekly: { intervals: [1, 2, 3, 4, 5, 6], unit: t('weeks') }, monthly: { intervals: [1, 2, 3, 4, 6], unit: t('months') }, yearly: { intervals: [1], unit: t('years') } }; const handleChange = e => setFormData(prev => ({...prev, [e.target.name]: e.target.value})); const handleRecurrenceChange = e => setRecurrence({...recurrence, [e.target.name]: e.target.value}); const handleSubmit = e => { e.preventDefault(); if (!formData.titolo || !formData.startDate || !formData.startTime || !formData.endDate || !formData.endTime) return; const inizio = new Date(`${formData.startDate}T${formData.startTime}`).toISOString(); const fine = new Date(`${formData.endDate}T${formData.endTime}`).toISOString(); const data = { ...turno, titolo: formData.titolo, colore: formData.colore, inizio, fine, note: formData.note }; if (isRecurring && !isEditMode) data.recurrence = recurrence; onSave(data); }; return ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-enter-active" role="dialog" aria-modal="true"> <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"> <h2 className="text-2xl font-bold mb-6">{isEditMode ? t('editShift') : t('addShift')}</h2> <form onSubmit={handleSubmit} className="space-y-4"> <div><label className="block text-sm font-medium">{t('shiftTitle')}</label><input type="text" name="titolo" value={formData.titolo} onChange={handleChange} placeholder={t('placeholderTitle')} required className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div> <div className="grid grid-cols-2 gap-4"> <div><label className="block text-sm font-medium">{t('startDate')}</label><input type="date" name="startDate" value={formData.startDate} onChange={handleChange} required className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div> <div><label className="block text-sm font-medium">{t('startTime')}</label><input type="time" name="startTime" value={formData.startTime} onChange={handleChange} required className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div> <div><label className="block text-sm font-medium">{t('endDate')}</label><input type="date" name="endDate" value={formData.endDate} onChange={handleChange} required className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div> <div><label className="block text-sm font-medium">{t('endTime')}</label><input type="time" name="endTime" value={formData.endTime} onChange={handleChange} required className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"/></div> </div> <div><label className="block text-sm font-medium">{t('notes')}</label><textarea name="note" value={formData.note} onChange={handleChange} rows="3" className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div> <div><label className="block text-sm font-medium mb-2">{t('color')}</label><div className="flex flex-wrap gap-2">{COLORS.map(c => <button type="button" key={c} aria-label={`${t('colorLabel')} ${c}`} onClick={() => setFormData(prev => ({ ...prev, colore: c }))} className={`w-8 h-8 rounded-full border-2 ${formData.colore === c ? 'ring-2 ring-blue-500' : 'border-transparent'}`} style={{ backgroundColor: c }}></button>)}</div></div> {!isEditMode && <div className="border-t pt-4"><label className="flex items-center space-x-3 cursor-pointer"><input type="checkbox" checked={isRecurring} onChange={() => setIsRecurring(!isRecurring)} className="h-5 w-5 rounded" /><span className="text-md font-medium">{t('recurringShift')}</span></label> {isRecurring && <div className="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg grid grid-cols-2 gap-4"> <div><label className="block text-sm font-medium">{t('frequency')}</label><select name="ruleType" value={recurrence.ruleType} onChange={handleRecurrenceChange} className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 form-select"><option value="daily">{t('daily')}</option><option value="weekly">{t('weekly')}</option><option value="monthly">{t('monthly')}</option><option value="yearly">{t('yearly')}</option></select></div> <div><label className="block text-sm font-medium">{t('repeatsEvery')}</label><div className="flex items-center gap-2"><select name="interval" value={recurrence.interval} onChange={handleRecurrenceChange} className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 form-select">{FREQUENCY_OPTIONS[recurrence.ruleType].intervals.map(i => <option key={i} value={i}>{i}</option>)}</select><span>{FREQUENCY_OPTIONS[recurrence.ruleType].unit}</span></div></div> </div>} </div>} <div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">{t('cancel')}</button><button type="submit" className="px-5 py-2.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold">{t('save')}</button></div> </form> </div> </div> ); }
        function ConfirmationModal({ title, message, onConfirm, onCancel, options }) { const { t } = useI18n(); return ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-enter-active" role="dialog" aria-modal="true"> <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md"> <h2 className="text-xl font-bold mb-2">{title}</h2><p className="text-gray-600 dark:text-gray-300 mb-6">{message}</p> <div className="space-y-3"> {options.map(opt => <button key={opt.key} onClick={() => onConfirm(opt.key)} className="w-full text-left px-5 py-2.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold">{opt.label}</button>)} </div> <div className="text-center mt-6"><button onClick={onCancel} className="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">{t('cancel')}</button></div> </div> </div> ); }
        function SimpleConfirmationModal({ title, message, onConfirm, onCancel }) { const { t } = useI18n(); return ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-enter-active" role="dialog" aria-modal="true"> <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md"> <h2 className="text-xl font-bold mb-2">{title}</h2><p className="text-gray-600 dark:text-gray-300 mb-6">{message}</p> <div className="flex justify-end space-x-3"> <button type="button" onClick={onCancel} className="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">{t('cancel')}</button> <button type="button" onClick={onConfirm} className="px-5 py-2.5 rounded-md bg-red-600 text-white hover:bg-red-700 font-semibold">{t('delete')}</button> </div> </div> </div> ); }
        function TurnoItem({ turno, onEdit, onDelete, isCompact = false }) { const { t, formatDate } = useI18n(); if (isCompact) { return (<div onClick={() => onEdit(turno)} className="p-1 mb-1 rounded-md text-xs cursor-pointer hover:opacity-80" style={{ backgroundColor: turno.colore, color: '#fff' }}> <span className="font-bold">{turno.titolo}</span><br/>{formatDate(turno.inizio, { timeOnly: true })} </div>); } return ( <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex items-start space-x-4"> <div className="w-2 h-16 rounded-full flex-shrink-0" style={{ backgroundColor: turno.colore }}></div> <div className="flex-grow"> <h3 className="font-bold text-lg text-gray-900 dark:text-white flex items-center"> {turno.titolo} {turno.serieId && <svg title={t('recurringShift')} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5 ml-2 text-gray-400"><path fillRule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.42 5.5 5.5 0 011.663-3.618 5.5 5.5 0 018.681 1.295A5.5 5.5 0 0115.312 11.424zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clipRule="evenodd" /></svg>} </h3> <p className="text-sm text-gray-600 dark:text-gray-400">{formatDate(turno.inizio)} &rarr; {formatDate(turno.fine)}</p> {turno.note && <p className="mt-2 text-sm text-gray-500 dark:text-gray-300 whitespace-pre-wrap">{turno.note}</p>} </div> <div className="flex space-x-1"> <button onClick={() => onEdit(turno)} aria-label={t('editShift')} className="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg></button> <button onClick={() => onDelete(turno)} aria-label={t('delete')} className="p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button> </div> </div> ); }
        function WeekView({ turni, currentDate, onEdit, onDelete }) { const { language } = useI18n(); const weekDays = useMemo(() => { const startOfWeek = new Date(currentDate); const day = startOfWeek.getDay(); const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); startOfWeek.setDate(diff); return Array.from({ length: 7 }).map((_, i) => new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + i)); }, [currentDate]); const turniByDay = useMemo(() => { const grouped = {}; weekDays.forEach(day => { const dayStr = day.toISOString().split('T')[0]; grouped[dayStr] = turni.filter(turno => isSameDay(new Date(turno.inizio), day)).sort((a,b) => new Date(a.inizio) - new Date(b.inizio)); }); return grouped; }, [turni, weekDays]); const today = new Date(); const dayFormatter = new Intl.DateTimeFormat(language, { weekday: 'long' }); return ( <div className="grid grid-cols-1 md:grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden"> {weekDays.map(day => { const dayStr = day.toISOString().split('T')[0]; const isToday = isSameDay(day, today); return ( <div key={dayStr} className="bg-white dark:bg-gray-800 p-2"> <div className={`flex justify-between items-center mb-2 pb-2 border-b-2 ${isToday ? 'border-blue-500' : 'border-transparent'}`}> <span className="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400">{dayFormatter.format(day).substring(0,3)}</span> <span className={`font-bold ${isToday ? 'text-blue-600 dark:text-blue-400' : ''}`}>{day.getDate()}</span> </div> <div className="space-y-2"> {turniByDay[dayStr].map(turno => <TurnoItem key={turno.id} turno={turno} onEdit={onEdit} onDelete={onDelete} isCompact={true} />)} </div> </div> ); })} </div> ); }
        function MonthView({ turni, currentDate, onEdit, onDelete }) { const { language } = useI18n(); const monthGrid = useMemo(() => { const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); const dayOfWeek = startOfMonth.getDay(); startOfMonth.setDate(startOfMonth.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); const grid = []; for (let i = 0; i < 42; i++) { grid.push(new Date(startOfMonth)); startOfMonth.setDate(startOfMonth.getDate() + 1); } return grid; }, [currentDate]); const today = new Date(); const weekDayFormatter = new Intl.DateTimeFormat(language, { weekday: 'short' }); const weekDays = useMemo(() => Array.from({length: 7}).map((_, i) => { const day = new Date(2024, 0, 1 + i); const dayIndex = day.getDay(); day.setDate(day.getDate() - dayIndex + (dayIndex === 0 ? -6 : 1) + i); return weekDayFormatter.format(day); }), [language]); return ( <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md"> <div className="grid grid-cols-7 text-center font-semibold text-gray-600 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700"> {weekDays.map(day => <div key={day} className="py-3">{day}</div>)} </div> <div className="grid grid-cols-7 grid-rows-6"> {monthGrid.map((day, index) => { const isCurrentMonth = day.getMonth() === currentDate.getMonth(); const isToday = isSameDay(day, today); const turniDelGiorno = turni.filter(turno => isSameDay(new Date(turno.inizio), day)); return ( <div key={index} className={`p-2 border-r border-b border-gray-200 dark:border-gray-700 min-h-[120px] ${!isCurrentMonth ? 'bg-gray-50 dark:bg-gray-800/50' : ''}`}> <span className={`flex items-center justify-center w-7 h-7 rounded-full text-sm font-semibold ${isToday ? 'bg-blue-600 text-white' : ''} ${!isCurrentMonth ? 'text-gray-400' : ''}`}>{day.getDate()}</span> <div className="mt-1"> {turniDelGiorno.slice(0, 2).map(t => <TurnoItem key={t.id} turno={t} onEdit={onEdit} onDelete={onDelete} isCompact={true} />)} {turniDelGiorno.length > 2 && <div className="text-xs text-gray-500 mt-1">+{turniDelGiorno.length - 2} more</div>} </div> </div> ); })} </div> </div> ); }
        function SettingsModal({ onClose, resetData, restoreData }) { const { t } = useI18n(); const restoreInputRef = useRef(null); const handleBackup = async () => { try { const allTurni = await db.turni.toArray(); const allSerie = await db.serie.toArray(); const data = { turni: allTurni, serie: allSerie }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'easyturno_backup.json'; a.click(); URL.revokeObjectURL(url); } catch (e) { alert(t('backupError')); } }; const handleRestoreClick = () => restoreInputRef.current.click(); const handleRestoreFile = async (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if(!data.turni || !data.serie) throw new Error("Invalid format"); await restoreData(data); alert(t('dataRestored')); onClose(); } catch (err) { alert(t('restoreError')); } }; reader.readAsText(file); }; const handleReset = () => { if (window.confirm(t('confirmResetMessage'))) { resetData(); onClose(); } }; return ( <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-enter-active"> <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg"> <div className="flex justify-between items-center mb-6"> <h2 className="text-2xl font-bold">{t('settings')}</h2> <button onClick={onClose} className="p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 dark:text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button> </div> <div className="space-y-4"> <h3 className="text-lg font-semibold border-b pb-2">{t('dataManagement')}</h3> <div className="flex items-center justify-between"><p><strong>{t('backup')}</strong><br/><span className="text-sm text-gray-500">{t('backupDesc')}</span></p><button onClick={handleBackup} className="px-5 py-2.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold">Download</button></div> <div className="flex items-center justify-between"><p><strong>{t('restore')}</strong><br/><span className="text-sm text-gray-500">{t('restoreDesc')}</span></p><button onClick={handleRestoreClick} className="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">Upload</button><input type="file" ref={restoreInputRef} onChange={handleRestoreFile} accept=".json" className="hidden"/></div> <div className="border-t pt-4 mt-4 flex items-center justify-between"><p><strong>{t('reset')}</strong><br/><span className="text-sm text-gray-500">{t('resetDesc')}</span></p><button onClick={handleReset} className="px-5 py-2.5 rounded-md bg-red-600 text-white hover:bg-red-700 font-semibold">Reset</button></div> </div> </div> </div> ); }

        // --- MAIN APP COMPONENT ---
        function App() {
            const { t, language } = useI18n();
            const { turni, isLoading, addTurno, updateTurno, deleteTurno, resetData, restoreData } = useTurni();
            const [modalState, setModalState] = useState({ isOpen: false, turno: null });
            const [confirmation, setConfirmation] = useState({ isOpen: false, action: null, turno: null, options: [] });
            const [simpleConfirmation, setSimpleConfirmation] = useState({ isOpen: false, turno: null });
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [view, setView] = useState('month');
            const [currentDate, setCurrentDate] = useState(new Date());

            const handleOpenModal = (turno = null) => setModalState({ isOpen: true, turno });
            const handleCloseModal = () => setModalState({ isOpen: false, turno: null });
            const handleSave = (data) => { if (data.id && data.serieId) { setConfirmation({ isOpen: true, action: 'edit', turno: data, options: [{key: 'single', label: t('thisEventOnly')}, {key: 'future', label: t('thisAndFutureEvents')}, {key: 'all', label: t('allEventsInSeries')}] }); } else if (data.id) { updateTurno(data, 'single'); handleCloseModal(); } else { addTurno(data); handleCloseModal(); } };
            
            const handleDelete = (turno) => {
                if (turno.serieId) {
                    setConfirmation({ isOpen: true, action: 'delete', turno, options: [{key: 'single', label: t('thisEventOnly')}, {key: 'future', label: t('thisAndFutureEvents')}, {key: 'all', label: t('allEventsInSeries')}] });
                } else {
                    setSimpleConfirmation({ isOpen: true, turno: turno });
                }
            };

            const handleConfirmation = async (choice) => { const { action, turno } = confirmation; if (action === 'edit') await updateTurno(turno, choice); if (action === 'delete') await deleteTurno(turno, choice); setConfirmation({ isOpen: false, action: null, turno: null, options: [] }); handleCloseModal(); };
            
            const handleSimpleConfirmDelete = () => {
                deleteTurno(simpleConfirmation.turno, 'single');
                setSimpleConfirmation({ isOpen: false, turno: null });
            };

            const handleDateChange = (amount) => { setCurrentDate(prevDate => { const newDate = new Date(prevDate); if (view === 'week') newDate.setDate(newDate.getDate() + amount * 7); if (view === 'month') newDate.setMonth(newDate.getMonth() + amount); return newDate; }); };
            const dateRangeDisplay = useMemo(() => { if (view === 'month') return currentDate.toLocaleDateString(language, { month: 'long', year: 'numeric' }); if (view === 'week') { const start = new Date(currentDate); const day = start.getDay(); start.setDate(start.getDate() - day + (day === 0 ? -6 : 1)); const end = new Date(start); end.setDate(start.getDate() + 6); return `${start.toLocaleDateString(language, { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString(language, { day: 'numeric', month: 'short', year: 'numeric' })}`; } return null; }, [currentDate, view, language]);

            return (
                <div className="min-h-screen flex flex-col">
                    <AppHeader view={view} setView={setView} onSettingsClick={() => setSettingsOpen(true)} />
                    {view !== 'list' && ( <div className="bg-white dark:bg-gray-800 py-3 px-4 sm:px-6 lg:px-8 flex items-center justify-between border-b border-gray-200 dark:border-gray-700"> <h2 className="text-lg font-semibold capitalize">{dateRangeDisplay}</h2> <div className="flex items-center space-x-2"> <button onClick={() => setCurrentDate(new Date())} className="px-4 py-1.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold">{t('today')}</button> <button onClick={() => handleDateChange(-1)} className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&lt; {t('prev')}</button> <button onClick={() => handleDateChange(1)} className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">{t('next')} &gt;</button> </div> </div> )}
                    <main className="flex-grow p-4 md:p-8">
                        <div className="max-w-7xl mx-auto">
                           {isLoading ? <p className="text-center">{t('loading')}</p> : (
                                <>
                                    {view === 'list' && <TurnoList turni={turni} onEdit={handleOpenModal} onDelete={handleDelete} />}
                                    {view === 'week' && <WeekView turni={turni} currentDate={currentDate} onEdit={handleOpenModal} onDelete={handleDelete} />}
                                    {view === 'month' && <MonthView turni={turni} currentDate={currentDate} onEdit={handleOpenModal} onDelete={handleDelete} />}
                                </>
                           )}
                        </div>
                    </main>
                    <FloatingActionButton onClick={() => handleOpenModal()} />
                    {modalState.isOpen && <TurnoModal turno={modalState.turno} onClose={handleCloseModal} onSave={handleSave} />}
                    {confirmation.isOpen && <ConfirmationModal title={confirmation.action === 'edit' ? t('editRecurringTitle') : t('deleteRecurringTitle')} message={confirmation.action === 'edit' ? t('editRecurringMessage') : t('deleteRecurringMessage')} onConfirm={handleConfirmation} onCancel={() => setConfirmation({ isOpen: false, action: null, turno: null, options: [] })} options={confirmation.options} />}
                    {simpleConfirmation.isOpen && <SimpleConfirmationModal title={t('confirmDeleteTitle')} message={t('confirmDeleteMessage')} onConfirm={handleSimpleConfirmDelete} onCancel={() => setSimpleConfirmation({ isOpen: false, turno: null })} />}
                    {settingsOpen && <SettingsModal onClose={() => setSettingsOpen(false)} resetData={resetData} restoreData={restoreData} />}
                </div>
            );
        }

        // --- RENDER APP ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<LanguageProvider><App /></LanguageProvider>);
    </script>
</body>
</html>

